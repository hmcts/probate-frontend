{% extends "includes/layout.html" %}

{% from "govuk/components/table/macro.njk" import govukTable %}

{% block content %}
    {% set applicationRows = [] %}
    {% for application in fields.applications.value %}
        {% set actionUrl = "/get-case/" + application.ccdCase.id + '?probateType=' + application.caseType %}
        {% set actionText = content.actionContinue if (application.ccdCase.state == "Draft" or application.ccdCase.state == "PAAppCreated" or application.ccdCase.state == "CasePaymentFailed") else content.actionView %}

        {% set caseClasses = "case draft" if not application.deceasedFullName and application.ccdCase.state == "Draft" %}
        {% set caseStatusClasses = "case-status in-progress" if (application.ccdCase.state == "Draft" or application.ccdCase.state == "PAAppCreated" or application.ccdCase.state == "CasePaymentFailed") else "case-status submitted" %}

        {% set applicationRows = (applicationRows.push([
            { text: application.ccdCase.idFormatted, classes: caseClasses, attributes: {'aria-label': application.ccdCase.idFormattedAccessible } },
            { text: application.deceasedFullName if application.deceasedFullName else content.statusDraft, classes: caseClasses },
            { text: application.dateCreated, classes: caseClasses},
            { text: content.statusInProgress if (application.ccdCase.state == "Draft" or application.ccdCase.state == "PAAppCreated" or application.ccdCase.state == "CasePaymentFailed") else content.statusSubmitted, classes: caseStatusClasses },
            { html: "<a href=\"" + actionUrl + "\" class=\"govuk-link\">" + actionText + "</a>"  }
        ]), applicationRows) %}
    {% endfor %}
    {% set applicationRows = (applicationRows.push([
        { text: "", classes: "no-bottom-border" },
        { text: "", classes: "no-bottom-border" },
        { text: "", classes: "no-bottom-border" },
        { text: "", classes: "no-bottom-border" },
        { html: "<a href=\"/start-eligibility\" class=\"govuk-link\">" + content.actionStartNewApplication + "</a>", classes: "no-bottom-border" }
    ]), applicationRows) %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h1 class="govuk-heading-l">{{ content.header }}</h1>

            {{ govukTable({
                caption: content.header | safe,
                captionClasses: "govuk-visually-hidden",
                head: [
                    { text: content.tableHeaderCcdCaseId },
                    { text: content.tableHeaderDeceasedName },
                    { text: content.tableHeaderCreateDate },
                    { text: content.tableHeaderCaseStatus },
                    { html: "<span class=\"govuk-visually-hidden\">" + content.tableHeaderActions + "</span>" }
                ],
                rows: applicationRows
            }) }}

            {% include "includes/help_details.html" %}
        </div>
    </div>
{% endblock %}
